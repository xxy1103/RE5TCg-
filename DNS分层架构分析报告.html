<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNSæœåŠ¡å™¨åˆ†å±‚æ¶æ„åˆ†ææŠ¥å‘Š</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <script>
        // å¤‡ç”¨CDNåŠ è½½
        if (typeof mermaid === 'undefined') {
            console.warn('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            var script = document.createElement('script');
            script.src = 'https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js';
            document.head.appendChild(script);
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #2980b9;
            margin-top: 20px;
        }
        .layer-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        .layer-header {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .feature-list {
            list-style-type: none;
            padding: 0;
        }
        .feature-list li {
            background: #e8f4fd;
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }
        .code-snippet {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 10px 0;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mermaid-loading {
            background: #f8f9fa;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        /* ç¡®ä¿MermaidèŠ‚ç‚¹æ ·å¼ */
        .mermaid .node rect,
        .mermaid .node circle,
        .mermaid .node ellipse,
        .mermaid .node polygon {
            fill: #3498db;
            stroke: #2980b9;
            stroke-width: 2px;
        }
        .mermaid .node text {
            fill: white;
            font-size: 14px;
            font-weight: bold;
        }
        .architecture-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .architecture-table th,
        .architecture-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .architecture-table th {
            background-color: #3498db;
            color: white;
        }
        .architecture-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .tech-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-item {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ DNSæœåŠ¡å™¨åˆ†å±‚æ¶æ„åˆ†ææŠ¥å‘Š</h1>
        
        <div class="highlight">
            <strong>é¡¹ç›®æ¦‚è¿°ï¼š</strong>è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¤šçº¿ç¨‹çš„DNSä¸­ç»§æœåŠ¡å™¨ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ”¯æŒåŸŸåè§£æã€ç¼“å­˜æœºåˆ¶ã€è´Ÿè½½å‡è¡¡å’Œä¸è‰¯ç½‘ç«™æ‹¦æˆªåŠŸèƒ½ã€‚
        </div>

        <h2>ğŸ“Š ç³»ç»Ÿåˆ†å±‚æ¶æ„å›¾</h2>
        <div class="mermaid" id="architecture-diagram">
            graph TB
                subgraph ClientLayer["1. å®¢æˆ·ç«¯å±‚"]
                    Client["DNSå®¢æˆ·ç«¯è¯·æ±‚"]
                end
                
                subgraph AppLayer["2. åº”ç”¨å±‚"]
                    App["ç¨‹åºå…¥å£ & é…ç½®ç®¡ç†"]
                end
                
                subgraph ServiceLayer["3. æœåŠ¡å±‚"]
                    Service["å¤šçº¿ç¨‹æœåŠ¡å™¨ & ä»»åŠ¡é˜Ÿåˆ—"]
                end
                
                subgraph BusinessLayer["4. ä¸šåŠ¡é€»è¾‘å±‚"]
                    Business["DNSç¼“å­˜ & IDæ˜ å°„ & æœ¬åœ°åŸŸåè¡¨"]
                end
                
                subgraph NetworkLayer["5. ç½‘ç»œå±‚"]
                    Network["ç½‘ç»œé€šä¿¡ & DNSåè®®å¤„ç†"]
                end
                
                subgraph PlatformLayer["6. å¹³å°æŠ½è±¡å±‚"]
                    Platform["è·¨å¹³å°å…¼å®¹ & çº¿ç¨‹/SocketæŠ½è±¡"]
                end
                
                subgraph InfraLayer["7. åŸºç¡€è®¾æ–½å±‚"]
                    Infra["æ—¥å¿—ç³»ç»Ÿ & å†…å­˜ç®¡ç†"]
                end
                
                subgraph UpstreamLayer["ä¸Šæ¸¸æœåŠ¡"]
                    Upstream["ä¸Šæ¸¸DNSæœåŠ¡å™¨æ± "]
                end

                Client --> App
                App --> Service
                Service --> Business
                Business --> Network
                Network --> Platform
                Platform --> Infra
                Network --> Upstream
                
                classDef layerStyle fill:#e8f4fd,stroke:#2980b9,stroke-width:3px,color:#2c3e50
                classDef upstreamStyle fill:#fff3cd,stroke:#e67e22,stroke-width:2px,color:#d35400
                
                class Client,App,Service,Business,Network,Platform,Infra layerStyle
                class Upstream upstreamStyle
        </div>

        <h2>ğŸ—ï¸ è¯¦ç»†åˆ†å±‚è¯´æ˜</h2>

        <div class="layer-section">
            <div class="layer-header">ç¬¬1å±‚ï¼šå®¢æˆ·ç«¯å±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>æ¥æ”¶DNSå®¢æˆ·ç«¯çš„åŸŸåè§£æè¯·æ±‚ï¼Œç›‘å¬UDP 53ç«¯å£</p>
        </div>

        <div class="layer-section">
            <div class="layer-header">ç¬¬2å±‚ï¼šåº”ç”¨å±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>ç¨‹åºå…¥å£ç‚¹ï¼Œè´Ÿè´£ç³»ç»Ÿåˆå§‹åŒ–ã€é…ç½®ç®¡ç†å’Œç¨‹åºç”Ÿå‘½å‘¨æœŸæ§åˆ¶</p>
        </div>

        <div class="layer-section">
            <div class="layer-header">ç¬¬3å±‚ï¼šæœåŠ¡å±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>é«˜å¹¶å‘è¯·æ±‚å¤„ç†ï¼Œé‡‡ç”¨å¤šçº¿ç¨‹æ¶æ„å’Œä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶</p>
        </div>

        <div class="layer-section">
            <div class="layer-header">ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>DNSæ ¸å¿ƒä¸šåŠ¡å¤„ç†ï¼ŒåŒ…æ‹¬ç¼“å­˜ç®¡ç†ã€IDæ˜ å°„å’Œæœ¬åœ°åŸŸåè¡¨æŸ¥è¯¢</p>
        </div>

        <div class="layer-section">
            <div class="layer-header">ç¬¬5å±‚ï¼šç½‘ç»œå±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>ç½‘ç»œé€šä¿¡å’ŒDNSåè®®å¤„ç†ï¼Œè´Ÿè½½å‡è¡¡å’Œä¸Šæ¸¸æœåŠ¡å™¨ç®¡ç†</p>
        </div>

        <div class="layer-section">
            <div class="layer-header">ç¬¬6å±‚ï¼šå¹³å°æŠ½è±¡å±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>è·¨å¹³å°å…¼å®¹æ€§æ”¯æŒï¼Œç»Ÿä¸€Windows/Linuxçš„APIæ¥å£</p>
        </div>

        <div class="layer-section">
            <div class="layer-header">ç¬¬7å±‚ï¼šåŸºç¡€è®¾æ–½å±‚</div>
            <p><strong>åŠŸèƒ½ï¼š</strong>ç³»ç»ŸåŸºç¡€æœåŠ¡ï¼ŒåŒ…æ‹¬æ—¥å¿—è®°å½•å’Œå†…å­˜ç®¡ç†</p>
        </div>

        <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
            <h3 style="color: #17a2b8; margin-top: 0;">ğŸ’¡ è¯¦ç»†æŠ€æœ¯å®ç°</h3>
            <p style="color: #6c757d;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹å„å±‚çš„è¯¦ç»†æŠ€æœ¯å®ç°å’Œä»£ç ç¤ºä¾‹</p>
            <button onclick="toggleDetails()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                æ˜¾ç¤º/éšè—è¯¦ç»†å®ç°
            </button>
        </div>

        <div id="detailed-implementation" style="display: none;">
            <h3>ğŸ“‹ è¯¦ç»†åˆ†å±‚å®ç°</h3>
            
            <div class="layer-section">
                <div class="layer-header">åº”ç”¨å±‚ - è¯¦ç»†å®ç°</div>
                <p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong><code>src/main.c</code></p>
                <ul class="feature-list">
                    <li>å‘½ä»¤è¡Œå‚æ•°è§£æï¼ˆ-hå¸®åŠ©, -dæ—¥å¿—çº§åˆ«, -cé…ç½®æ–‡ä»¶, -råŸŸåè¡¨ï¼‰</li>
                    <li>ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆå¹³å°èµ„æºã€æ—¥å¿—ç³»ç»Ÿã€åŸŸåè¡¨ã€ä¸Šæ¸¸æœåŠ¡å™¨æ± ï¼‰</li>
                    <li>é…ç½®æ–‡ä»¶éªŒè¯å’ŒåŠ è½½</li>
                    <li>ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
                </ul>
                <div class="code-snippet">
// ä¸»è¦åˆå§‹åŒ–æµç¨‹
platform_init();                    // åˆå§‹åŒ–å¹³å°èµ„æº
dns_relay_init(config_file);         // åˆå§‹åŒ–æœ¬åœ°åŸŸåè¡¨
upstream_pool_init(&g_upstream_pool, dns_server_ip_conf); // åˆå§‹åŒ–ä¸Šæ¸¸DNSæ± 
start_dns_proxy_server_threaded();  // å¯åŠ¨å¤šçº¿ç¨‹DNSæœåŠ¡å™¨
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">æœåŠ¡å±‚ - è¯¦ç»†å®ç°</div>
                <p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong><code>src/websocket/dnsServer.c</code>, <code>src/Thread/thread_pool.c</code></p>
                <ul class="feature-list">
                    <li>å¤šçº¿ç¨‹DNSä»£ç†æœåŠ¡å™¨ (é»˜è®¤16ä¸ªå·¥ä½œçº¿ç¨‹)</li>
                    <li>åŸºäºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„ä»»åŠ¡é˜Ÿåˆ— (æœ€å¤§10000ä¸ªä»»åŠ¡)</li>
                    <li>ä»»åŠ¡ç±»å‹åˆ†ç±»ï¼šå®¢æˆ·ç«¯è¯·æ±‚ã€ä¸Šæ¸¸å“åº”ã€å…³é—­ä¿¡å·</li>
                    <li>çº¿ç¨‹æ± çŠ¶æ€ç›‘æ§å’Œç»Ÿè®¡</li>
                    <li>ä¼˜é›…å…³é—­æœºåˆ¶</li>
                </ul>
                <div class="code-snippet">
// çº¿ç¨‹æ± é…ç½®
#define DEFAULT_WORKER_THREADS 16    // é»˜è®¤å·¥ä½œçº¿ç¨‹æ•°
#define MAX_QUEUE_SIZE 10000         // ä»»åŠ¡é˜Ÿåˆ—æœ€å¤§å®¹é‡
#define QUEUE_TIMEOUT_MS 500         // é˜Ÿåˆ—æ“ä½œè¶…æ—¶æ—¶é—´

// ä»»åŠ¡ç±»å‹
typedef enum {
    TASK_CLIENT_REQUEST,    // å®¢æˆ·ç«¯DNSè¯·æ±‚
    TASK_UPSTREAM_RESPONSE, // ä¸Šæ¸¸æœåŠ¡å™¨å“åº”
    TASK_SHUTDOWN          // å…³é—­ä¿¡å·
} task_type_t;
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">ä¸šåŠ¡é€»è¾‘å±‚ - è¯¦ç»†å®ç°</div>
                <p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong><code>src/DNScache/relayBuild.c</code>, <code>src/idmapping/idmapping.c</code></p>
                
                <h4>ğŸ—ƒï¸ DNSç¼“å­˜å­ç³»ç»Ÿ</h4>
                <ul class="feature-list">
                    <li>LRUç¼“å­˜æœºåˆ¶ (å®¹é‡1000æ¡è®°å½•)</li>
                    <li>åˆ†æ®µé”è®¾è®¡ (64ä¸ªæ®µï¼Œå‡å°‘é”ç«äº‰)</li>
                    <li>æœ¬åœ°åŸŸåè¡¨ç®¡ç† (æ”¯æŒ8192ä¸ªå“ˆå¸Œæ¡¶ï¼Œ128ä¸ªåˆ†æ®µ)</li>
                    <li>ä¸è‰¯ç½‘ç«™æ‹¦æˆª (0.0.0.0æ ‡è®°)</li>
                    <li>TTLè¿‡æœŸç®¡ç†</li>
                </ul>
                
                <h4>ğŸ”„ IDæ˜ å°„å­ç³»ç»Ÿ</h4>
                <ul class="feature-list">
                    <li>å®¢æˆ·ç«¯è¯·æ±‚IDä¸ä¸Šæ¸¸è¯·æ±‚IDæ˜ å°„</li>
                    <li>å“ˆå¸Œè¡¨å¿«é€ŸæŸ¥æ‰¾ (16384ä¸ªæ¡¶)</li>
                    <li>é¢„åˆ†é…å†…å­˜æ±  (æœ€å¤§10000ä¸ªå¹¶å‘è¯·æ±‚)</li>
                    <li>è¯·æ±‚è¶…æ—¶æ¸…ç† (3ç§’è¶…æ—¶)</li>
                </ul>
                
                <div class="code-snippet">
// æŸ¥è¯¢ç»“æœç±»å‹
typedef enum {
    QUERY_RESULT_BLOCKED,     // åŸŸåè¢«é˜»æ­¢
    QUERY_RESULT_LOCAL_HIT,   // æœ¬åœ°è¡¨å‘½ä¸­
    QUERY_RESULT_CACHE_HIT,   // ç¼“å­˜å‘½ä¸­
    QUERY_RESULT_CACHE_MISS,  // ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦ä¸Šæ¸¸æŸ¥è¯¢
    QUERY_RESULT_ERROR        // æŸ¥è¯¢é”™è¯¯
} dns_query_result_t;
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">ç½‘ç»œå±‚ - è¯¦ç»†å®ç°</div>
                <p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong><code>src/websocket/websocket.c</code>, <code>src/websocket/datagram.c</code></p>
                
                <h4>ğŸŒ ç½‘ç»œé€šä¿¡æ¨¡å—</h4>
                <ul class="feature-list">
                    <li>ä¸Šæ¸¸DNSæœåŠ¡å™¨æ± ç®¡ç† (æœ€å¤§10ä¸ªæœåŠ¡å™¨)</li>
                    <li>è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šéšæœºé€‰æ‹©å’Œè½®è¯¢</li>
                    <li>é…ç½®æ–‡ä»¶åŠ¨æ€åŠ è½½</li>
                    <li>ç½‘ç»œé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶</li>
                </ul>
                
                <h4>ğŸ“¦ DNSæŠ¥æ–‡å¤„ç†æ¨¡å—</h4>
                <ul class="feature-list">
                    <li>DNSåè®®æŠ¥æ–‡è§£æå’Œåºåˆ—åŒ–</li>
                    <li>æ”¯æŒAã€AAAAã€CNAMEã€MXè®°å½•ç±»å‹</li>
                    <li>DNSå‹ç¼©æ ¼å¼å¤„ç†</li>
                    <li>åŸŸåæ ¼å¼è½¬æ¢ (æ ‡å‡†æ ¼å¼ â†” DNSæ ¼å¼)</li>
                </ul>
                
                <div class="code-snippet">
// DNSæŠ¥æ–‡ç»“æ„
typedef struct DNS_ENTITY{
    unsigned short id;       // äº‹åŠ¡ID
    unsigned short flags;    // æ ‡å¿—ä½
    unsigned short qdcount;  // é—®é¢˜æ•°
    unsigned short ancount;  // å›ç­”æ•°
    unsigned short nscount;  // æˆæƒå›ç­”æ•°
    unsigned short arcount;  // é™„åŠ å›ç­”æ•°
    DNS_QUESTION_ENTITY* questions; // é—®é¢˜éƒ¨åˆ†
    R_DATA_ENTITY* answers;         // å›ç­”éƒ¨åˆ†
    R_DATA_ENTITY* authorities;     // æƒå¨è®°å½•éƒ¨åˆ†
    R_DATA_ENTITY* additionals;     // é™„åŠ è®°å½•éƒ¨åˆ†
} DNS_ENTITY;
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">å¹³å°æŠ½è±¡å±‚ - è¯¦ç»†å®ç°</div>
                <p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong><code>src/platform/platform.c</code></p>
                <ul class="feature-list">
                    <li>Windowså’ŒLinuxå¹³å°ç»Ÿä¸€API</li>
                    <li>çº¿ç¨‹APIæŠ½è±¡ (pthreadåœ¨Windowsä¸Šçš„å®ç°)</li>
                    <li>Socket APIç»Ÿä¸€æ¥å£</li>
                    <li>è¯»å†™é”å®ç° (Windowså¹³å°è‡ªå®šä¹‰å®ç°)</li>
                    <li>æ¡ä»¶å˜é‡å’Œäº’æ–¥é”æŠ½è±¡</li>
                </ul>
                <div class="code-snippet">
// è·¨å¹³å°çº¿ç¨‹ç±»å‹å®šä¹‰ (Windows)
typedef HANDLE pthread_t;
typedef CRITICAL_SECTION pthread_mutex_t;
typedef CONDITION_VARIABLE pthread_cond_t;

// ç»Ÿä¸€çš„APIæ¥å£
int platform_mutex_init(pthread_mutex_t* mutex, const pthread_mutexattr_t* attr);
int platform_thread_create(pthread_t* thread, const pthread_attr_t* attr, 
                          THREAD_RETURN_TYPE (*start_routine)(void*), void* arg);
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">åŸºç¡€è®¾æ–½å±‚ - è¯¦ç»†å®ç°</div>
                <p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong><code>src/debug/debug.c</code>, <code>src/DNScache/free_stack.c</code></p>
                
                <h4>ğŸ“ æ—¥å¿—ç³»ç»Ÿ</h4>
                <ul class="feature-list">
                    <li>å¤šçº§åˆ«æ—¥å¿— (ERROR, WARN, INFO, DEBUG)</li>
                    <li>æ–‡ä»¶æ—¥å¿—è®°å½•</li>
                    <li>è¿è¡Œæ—¶æ—¥å¿—çº§åˆ«è°ƒæ•´</li>
                    <li>å¸¦æ—¶é—´æˆ³å’Œä½ç½®ä¿¡æ¯çš„æ—¥å¿—æ ¼å¼</li>
                </ul>
                
                <h4>ğŸ§  å†…å­˜ç®¡ç†</h4>
                <ul class="feature-list">
                    <li>ç©ºé—²å†…å­˜æ ˆç®¡ç†</li>
                    <li>å†…å­˜æ± é¢„åˆ†é…</li>
                    <li>é«˜æ•ˆçš„å†…å­˜åˆ†é…å’Œå›æ”¶</li>
                </ul>
            </div>
        </div>

        <script>
            function toggleDetails() {
                const details = document.getElementById('detailed-implementation');
                if (details.style.display === 'none') {
                    details.style.display = 'block';
                } else {
                    details.style.display = 'none';
                }
            }
        </script>

        <h2>ğŸ“ˆ æŠ€æœ¯æ ˆå’Œæ€§èƒ½ç‰¹æ€§</h2>
        
        <div class="tech-stack">
            <div class="tech-item">
                <h3>ç¼–ç¨‹è¯­è¨€</h3>
                <p>C99æ ‡å‡†</p>
            </div>
            <div class="tech-item">
                <h3>æ„å»ºå·¥å…·</h3>
                <p>CMake 3.10+</p>
            </div>
            <div class="tech-item">
                <h3>ç½‘ç»œåè®®</h3>
                <p>UDP/DNSåè®®</p>
            </div>
            <div class="tech-item">
                <h3>å¹¶å‘æ¨¡å‹</h3>
                <p>å¤šçº¿ç¨‹+ä»»åŠ¡é˜Ÿåˆ—</p>
            </div>
            <div class="tech-item">
                <h3>å¹³å°æ”¯æŒ</h3>
                <p>Windows/Linux</p>
            </div>
            <div class="tech-item">
                <h3>ç¼“å­˜ç­–ç•¥</h3>
                <p>LRUç®—æ³•</p>
            </div>
        </div>

        <h2>âš¡ æ€§èƒ½æŒ‡æ ‡</h2>
        
        <div class="performance-metrics">
            <div class="metric-item">
                <div class="metric-value">16</div>
                <div>å·¥ä½œçº¿ç¨‹æ•°</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">10K</div>
                <div>æœ€å¤§å¹¶å‘è¯·æ±‚</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">1000</div>
                <div>ç¼“å­˜å®¹é‡</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">64</div>
                <div>ç¼“å­˜åˆ†æ®µæ•°</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">3s</div>
                <div>è¯·æ±‚è¶…æ—¶æ—¶é—´</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">10</div>
                <div>ä¸Šæ¸¸æœåŠ¡å™¨æ± å¤§å°</div>
            </div>
        </div>

        <h2>ğŸ”§ æ¶æ„è®¾è®¡ä¼˜åŠ¿</h2>

        <table class="architecture-table">
            <thead>
                <tr>
                    <th>è®¾è®¡ç‰¹æ€§</th>
                    <th>æŠ€æœ¯å®ç°</th>
                    <th>æ€§èƒ½ä¼˜åŠ¿</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>åˆ†å±‚æ¶æ„</td>
                    <td>7å±‚æ¸…æ™°åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®</td>
                    <td>æ˜“äºç»´æŠ¤ã€æ‰©å±•å’Œæµ‹è¯•</td>
                </tr>
                <tr>
                    <td>å¤šçº¿ç¨‹å¹¶å‘</td>
                    <td>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œ16ä¸ªå·¥ä½œçº¿ç¨‹</td>
                    <td>é«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ”¯æŒ10Kå¹¶å‘è¯·æ±‚</td>
                </tr>
                <tr>
                    <td>åˆ†æ®µé”æœºåˆ¶</td>
                    <td>ç¼“å­˜å’ŒåŸŸåè¡¨é‡‡ç”¨64/128ä¸ªåˆ†æ®µ</td>
                    <td>å‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘æ€§èƒ½</td>
                </tr>
                <tr>
                    <td>å†…å­˜æ± ç®¡ç†</td>
                    <td>é¢„åˆ†é…+ç©ºé—²æ ˆç®¡ç†</td>
                    <td>å‡å°‘å†…å­˜åˆ†é…å¼€é”€ï¼Œé¿å…å†…å­˜ç¢ç‰‡</td>
                </tr>
                <tr>
                    <td>LRUç¼“å­˜</td>
                    <td>å“ˆå¸Œè¡¨+åŒå‘é“¾è¡¨å®ç°</td>
                    <td>O(1)ç¼“å­˜è®¿é—®ï¼Œè‡ªåŠ¨æ·˜æ±°è¿‡æœŸæ•°æ®</td>
                </tr>
                <tr>
                    <td>è´Ÿè½½å‡è¡¡</td>
                    <td>ä¸Šæ¸¸æœåŠ¡å™¨æ± +è½®è¯¢/éšæœºç­–ç•¥</td>
                    <td>åˆ†æ•£è´Ÿè½½ï¼Œæé«˜å¯é æ€§</td>
                </tr>
                <tr>
                    <td>è·¨å¹³å°æ”¯æŒ</td>
                    <td>å¹³å°æŠ½è±¡å±‚ç»Ÿä¸€API</td>
                    <td>Windows/Linuxæ— ç¼å…¼å®¹</td>
                </tr>
            </tbody>
        </table>

        <h2>ğŸ“Š æ•°æ®æµå¤„ç†æµç¨‹</h2>
        
        <div class="mermaid" id="dataflow-diagram">
            sequenceDiagram
                participant Client as DNSå®¢æˆ·ç«¯
                participant Server as DNSæœåŠ¡å™¨
                participant ThreadPool as çº¿ç¨‹æ± 
                participant Cache as ç¼“å­˜ç³»ç»Ÿ
                participant LocalTable as æœ¬åœ°åŸŸåè¡¨
                participant IDMapping as IDæ˜ å°„
                participant Upstream as ä¸Šæ¸¸DNS
                
                Client->>Server: DNSæŸ¥è¯¢è¯·æ±‚
                Server->>ThreadPool: æäº¤å®¢æˆ·ç«¯ä»»åŠ¡
                ThreadPool->>LocalTable: æ£€æŸ¥æœ¬åœ°åŸŸåè¡¨
                
                alt æœ¬åœ°è¡¨å‘½ä¸­é˜»æ­¢åŸŸå
                    LocalTable-->>ThreadPool: è¿”å›é˜»æ­¢å“åº”
                    ThreadPool-->>Client: é˜»æ­¢è®¿é—®
                else æœ¬åœ°è¡¨å‘½ä¸­æ­£å¸¸åŸŸå
                    LocalTable-->>ThreadPool: è¿”å›æœ¬åœ°IP
                    ThreadPool-->>Client: è¿”å›æœ¬åœ°è§£æç»“æœ
                else æœ¬åœ°è¡¨æœªå‘½ä¸­
                    ThreadPool->>Cache: æ£€æŸ¥ç¼“å­˜
                    alt ç¼“å­˜å‘½ä¸­
                        Cache-->>ThreadPool: è¿”å›ç¼“å­˜ç»“æœ
                        ThreadPool-->>Client: è¿”å›ç¼“å­˜æ•°æ®
                    else ç¼“å­˜æœªå‘½ä¸­
                        ThreadPool->>IDMapping: åˆ†é…æ–°ID
                        IDMapping-->>ThreadPool: è¿”å›æ˜ å°„ID
                        ThreadPool->>Upstream: è½¬å‘åˆ°ä¸Šæ¸¸DNS
                        Upstream-->>ThreadPool: ä¸Šæ¸¸å“åº”
                        ThreadPool->>IDMapping: æŸ¥æ‰¾åŸå§‹å®¢æˆ·ç«¯
                        ThreadPool->>Cache: ç¼“å­˜å“åº”ç»“æœ
                        ThreadPool-->>Client: è¿”å›è§£æç»“æœ
                    end
                end
        </div>

        <h2>ğŸ¯ æ€»ç»“</h2>
        
        <div class="highlight">
            <p>è¯¥DNSæœåŠ¡å™¨é‡‡ç”¨äº†ç»å…¸çš„<strong>7å±‚åˆ†å±‚æ¶æ„</strong>è®¾è®¡ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯ï¼šå®¢æˆ·ç«¯å±‚ã€åº”ç”¨å±‚ã€æœåŠ¡å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€ç½‘ç»œå±‚ã€å¹³å°æŠ½è±¡å±‚å’ŒåŸºç¡€è®¾æ–½å±‚ã€‚</p>
            
            <p><strong>æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š</strong></p>
            <ul>
                <li><strong>é«˜æ€§èƒ½ï¼š</strong>å¤šçº¿ç¨‹å¹¶å‘ + åˆ†æ®µé” + å†…å­˜æ±  + LRUç¼“å­˜</li>
                <li><strong>é«˜å¯é ï¼š</strong>è´Ÿè½½å‡è¡¡ + é”™è¯¯å¤„ç† + ä¼˜é›…å…³é—­</li>
                <li><strong>æ˜“ç»´æŠ¤ï¼š</strong>åˆ†å±‚æ¶æ„ + æ¨¡å—åŒ–è®¾è®¡ + ç»Ÿä¸€æ¥å£</li>
                <li><strong>è·¨å¹³å°ï¼š</strong>å¹³å°æŠ½è±¡å±‚å®ç°Windows/Linuxå…¼å®¹</li>
            </ul>
            
            <p>è¿™ç§æ¶æ„è®¾è®¡ä½¿å¾—ç³»ç»Ÿå…·å¤‡äº†<strong>é«˜å¹¶å‘å¤„ç†èƒ½åŠ›</strong>ï¼ˆæ”¯æŒ10Kå¹¶å‘ï¼‰ã€<strong>ä½å»¶è¿Ÿå“åº”</strong>ï¼ˆå¤šçº§ç¼“å­˜ï¼‰å’Œ<strong>è‰¯å¥½çš„æ‰©å±•æ€§</strong>ï¼ˆæ¨¡å—åŒ–è®¾è®¡ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå·¥ç¨‹åŒ–ç¨‹åº¦å¾ˆé«˜çš„DNSæœåŠ¡å™¨å®ç°ã€‚</p>
        </div>

        <hr>
        <p style="text-align: center; color: #7f8c8d; margin-top: 30px;">
            <small>ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š2025å¹´6æœˆ28æ—¥ | ğŸ”§ åŸºäºDNSæœåŠ¡å™¨é¡¹ç›®æºç åˆ†æ</small>
        </p>
    </div>

    <script>
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–Mermaid...');
            
            // æ£€æŸ¥Mermaidæ˜¯å¦æˆåŠŸåŠ è½½
            if (typeof mermaid === 'undefined') {
                console.error('MermaidæœªåŠ è½½ï¼');
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.querySelectorAll('.mermaid').forEach(function(element) {
                    element.innerHTML = '<div class="mermaid-loading">âš ï¸ Mermaidå›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
                });
                return;
            }

            try {
                // é…ç½®Mermaid
                mermaid.initialize({
                    startOnLoad: false, // æ‰‹åŠ¨æ§åˆ¶åˆå§‹åŒ–
                    theme: 'default',
                    themeVariables: {
                        primaryColor: '#3498db',
                        primaryTextColor: '#2c3e50',
                        primaryBorderColor: '#2980b9',
                        lineColor: '#34495e',
                        secondaryColor: '#ecf0f1',
                        tertiaryColor: '#f8f9fa',
                        background: '#ffffff',
                        mainBkg: '#3498db',
                        secondBkg: '#ecf0f1',
                        tertiaryColor: '#f8f9fa'
                    },
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis',
                        padding: 20
                    },
                    sequence: {
                        useMaxWidth: true,
                        wrap: true,
                        diagramMarginX: 50,
                        diagramMarginY: 10,
                        boxTextMargin: 5,
                        noteMargin: 10,
                        messageMargin: 35,
                        mirrorActors: true
                    },
                    gitgraph: {
                        useMaxWidth: true
                    }
                });

                console.log('Mermaidé…ç½®å®Œæˆï¼Œå¼€å§‹æ¸²æŸ“å›¾è¡¨...');

                // æ‰‹åŠ¨åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                
                console.log('Mermaidå›¾è¡¨æ¸²æŸ“å®Œæˆ');

            } catch (error) {
                console.error('Mermaidåˆå§‹åŒ–é”™è¯¯:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.querySelectorAll('.mermaid').forEach(function(element) {
                    element.innerHTML = '<div class="mermaid-loading">âŒ å›¾è¡¨æ¸²æŸ“å‡ºé”™: ' + error.message + '</div>';
                });
            }

            // é”™è¯¯å¤„ç†
            window.addEventListener('error', function(e) {
                if (e.message.includes('mermaid')) {
                    console.error('Mermaidè¿è¡Œæ—¶é”™è¯¯:', e.message);
                }
            });

            // å¤‡ç”¨æ¸²æŸ“ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼‰
            setTimeout(function() {
                try {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¸²æŸ“çš„å›¾è¡¨
                    const unrenderedElements = document.querySelectorAll('.mermaid:not([data-processed="true"])');
                    if (unrenderedElements.length > 0) {
                        console.log('å‘ç°æœªæ¸²æŸ“çš„å›¾è¡¨ï¼Œå°è¯•é‡æ–°æ¸²æŸ“...');
                        mermaid.init(undefined, unrenderedElements);
                    }
                } catch (e) {
                    console.warn('å¤‡ç”¨æ¸²æŸ“å¤±è´¥:', e);
                }
            }, 2000);
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–æ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(function() {
                // æœ€ç»ˆæ£€æŸ¥
                const mermaidElements = document.querySelectorAll('.mermaid');
                let successCount = 0;
                
                mermaidElements.forEach(function(element) {
                    if (element.querySelector('svg')) {
                        successCount++;
                    } else {
                        console.warn('å›¾è¡¨å¯èƒ½æœªæ­£ç¡®æ¸²æŸ“:', element.id || element.className);
                    }
                });
                
                console.log(`æˆåŠŸæ¸²æŸ“ ${successCount}/${mermaidElements.length} ä¸ªå›¾è¡¨`);
            }, 1000);
        });
    </script>
</body>
</html>
