# DNSä¸­ç»§æœåŠ¡å™¨LRUç¼“å­˜åŠŸèƒ½è¯´æ˜ä¹¦

## ğŸ“‹ ç›®å½•
1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ•°æ®ç»“æ„è¯¦è§£](#æ•°æ®ç»“æ„è¯¦è§£)
4. [å‡½æ•°æ¥å£è¯¦è§£](#å‡½æ•°æ¥å£è¯¦è§£)
5. [é›†æˆæŒ‡å—](#é›†æˆæŒ‡å—)
6. [æ€§èƒ½ç‰¹æ€§](#æ€§èƒ½ç‰¹æ€§)
7. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
8. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬LRUç¼“å­˜æ¨¡å—ä¸ºDNSä¸­ç»§æœåŠ¡å™¨æä¾›äº†é«˜æ€§èƒ½çš„åŸŸåè§£æç¼“å­˜åŠŸèƒ½ï¼Œä»¥å®ç°ã€Šè®¡ç®—æœºç½‘ç»œè¯¾ç¨‹è®¾è®¡ã€‹ä»»åŠ¡ä¹¦ä¸­å…³äº"å®ç°LRUæœºåˆ¶çš„Cacheç¼“å­˜"çš„è¦æ±‚ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- **ä¸‰çº§æŸ¥è¯¢æ¶æ„**: æœ¬åœ°åŸŸåè¡¨ â†’ LRUç¼“å­˜ â†’ ä¸Šæ¸¸DNSæœåŠ¡å™¨
- **LRUæ·˜æ±°ç­–ç•¥**: æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼Œè‡ªåŠ¨ç®¡ç†ç¼“å­˜å®¹é‡
- **TTLæ”¯æŒ**: åŸºäºDNSè®°å½•TTLçš„è‡ªåŠ¨è¿‡æœŸæœºåˆ¶
- **æ¶æ„ç½‘ç«™æ‹¦æˆª**: æ”¯æŒ0.0.0.0æ ‡è®°çš„åŸŸåé˜»æ­¢åŠŸèƒ½
- **é«˜æ€§èƒ½è®¾è®¡**: O(1)æŸ¥æ‰¾å’Œæ›´æ–°å¤æ‚åº¦
- **ç»Ÿè®¡ç›‘æ§**: å®Œæ•´çš„ç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½ç»Ÿè®¡

### ğŸ“‚ æ–‡ä»¶ç»“æ„
```
include/DNScache/relayBuild.h    # å¤´æ–‡ä»¶ï¼Œæ•°æ®ç»“æ„å’Œå‡½æ•°å£°æ˜
src/DNScache/relayBuild.c        # å®ç°æ–‡ä»¶ï¼Œæ ¸å¿ƒç®—æ³•é€»è¾‘
dnsrelay.txt                     # æœ¬åœ°åŸŸåè¡¨é…ç½®æ–‡ä»¶
```

---

## æ¶æ„è®¾è®¡

### ğŸ—ï¸ æ•´ä½“æ¶æ„å›¾
```
å®¢æˆ·ç«¯DNSæŸ¥è¯¢
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç»Ÿä¸€æŸ¥è¯¢æ¥å£   â”‚ â† dns_relay_query()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å‘½ä¸­ â†’ è¿”å›ç»“æœ
â”‚  æœ¬åœ°åŸŸåè¡¨æŸ¥è¯¢  â”‚ â† domain_table_lookup()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å‘½ä¸­ â†’ è¿”å›ç¼“å­˜
â”‚   LRUç¼“å­˜æŸ¥è¯¢   â”‚ â† dns_cache_get()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šæ¸¸DNSæŸ¥è¯¢    â”‚ â†’ æŸ¥è¯¢ç»“æœç¼“å­˜ â† dns_cache_put()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ LRUç®—æ³•åŸç†
```
å“ˆå¸Œè¡¨ç´¢å¼•: [0] [1] [2] ... [2047]
              â†“   â†“   â†“
           Entry Entry Entry
              â†“
LRUåŒå‘é“¾è¡¨: HEAD â†â†’ Entry1 â†â†’ Entry2 â†â†’ ... â†â†’ TAIL
            (æœ€æ–°)                              (æœ€æ—§)

è®¿é—®æ“ä½œ: ç§»åŠ¨åˆ°HEAD
æ·˜æ±°æ“ä½œ: ç§»é™¤TAIL
```

---

## æ•°æ®ç»“æ„è¯¦è§£

### 1. æœ¬åœ°åŸŸåè¡¨ç»“æ„

#### `domain_entry_t` - åŸŸåè¡¨æ¡ç›®
```c
typedef struct domain_entry {
    char domain[MAX_DOMAIN_LENGTH];     // åŸŸå (æœ€å¤§256å­—ç¬¦)
    char ip[MAX_IP_LENGTH];             // IPåœ°å€ (æœ€å¤§16å­—ç¬¦)
    int is_blocked;                     // é˜»æ­¢æ ‡è®° (0.0.0.0ä¸ºtrue)
    struct domain_entry* next;          // å“ˆå¸Œå†²çªé“¾è¡¨æŒ‡é’ˆ
} domain_entry_t;
```

#### `domain_table_t` - åŸŸåè¡¨ç®¡ç†å™¨
```c
typedef struct {
    domain_entry_t* hash_table[DOMAIN_TABLE_HASH_SIZE];  // 4096ä¸ªå“ˆå¸Œæ§½
    int entry_count;                    // å½“å‰æ¡ç›®æ•°é‡
    time_t last_load_time;              // æœ€ååŠ è½½æ—¶é—´
} domain_table_t;
```

### 2. LRUç¼“å­˜ç»“æ„

#### `dns_cache_entry_t` - ç¼“å­˜æ¡ç›®
```c
typedef struct dns_cache_entry {
    char domain[MAX_DOMAIN_LENGTH];     // åŸŸå
    DNS_ENTITY* dns_response;           // å®Œæ•´DNSå“åº”
    time_t expire_time;                 // è¿‡æœŸæ—¶é—´æˆ³
    time_t access_time;                 // æœ€åè®¿é—®æ—¶é—´
    
    // LRUåŒå‘é“¾è¡¨æŒ‡é’ˆ
    struct dns_cache_entry* prev;       // å‰é©±èŠ‚ç‚¹
    struct dns_cache_entry* next;       // åç»§èŠ‚ç‚¹
    
    // å“ˆå¸Œè¡¨é“¾è¡¨æŒ‡é’ˆ
    struct dns_cache_entry* hash_next;  // å“ˆå¸Œå†²çªé“¾è¡¨
} dns_cache_entry_t;
```

#### `dns_lru_cache_t` - LRUç¼“å­˜ç®¡ç†å™¨
```c
typedef struct {
    dns_cache_entry_t* hash_table[DNS_CACHE_HASH_SIZE];  // 2048ä¸ªå“ˆå¸Œæ§½
    dns_cache_entry_t* lru_head;        // LRUé“¾è¡¨å¤´(æœ€æ–°)
    dns_cache_entry_t* lru_tail;        // LRUé“¾è¡¨å°¾(æœ€æ—§)
    dns_cache_entry_t* entry_pool;      // é¢„åˆ†é…æ¡ç›®æ± 
    int current_size;                   // å½“å‰ç¼“å­˜å¤§å°
    int max_size;                       // æœ€å¤§ç¼“å­˜å®¹é‡
    
    // ç»Ÿè®¡ä¿¡æ¯
    unsigned long cache_hits;           // ç¼“å­˜å‘½ä¸­æ¬¡æ•°
    unsigned long cache_misses;         // ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
    unsigned long cache_evictions;      // ç¼“å­˜æ·˜æ±°æ¬¡æ•°
} dns_lru_cache_t;
```

### 3. æŸ¥è¯¢ç»“æœç»“æ„

#### `dns_query_result_t` - æŸ¥è¯¢ç»“æœç±»å‹
```c
typedef enum {
    QUERY_RESULT_BLOCKED,       // åŸŸåè¢«é˜»æ­¢ (0.0.0.0)
    QUERY_RESULT_LOCAL_HIT,     // æœ¬åœ°è¡¨å‘½ä¸­
    QUERY_RESULT_CACHE_HIT,     // ç¼“å­˜å‘½ä¸­
    QUERY_RESULT_CACHE_MISS,    // ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€ä¸Šæ¸¸æŸ¥è¯¢
    QUERY_RESULT_ERROR          // æŸ¥è¯¢é”™è¯¯
} dns_query_result_t;
```

#### `dns_query_response_t` - æŸ¥è¯¢å“åº”ç»“æ„
```c
typedef struct {
    dns_query_result_t result_type;     // æŸ¥è¯¢ç»“æœç±»å‹
    DNS_ENTITY* dns_response;           // DNSå“åº”(å¦‚æœæœ‰)
    char resolved_ip[MAX_IP_LENGTH];    // è§£æçš„IPåœ°å€
} dns_query_response_t;
```

---

## å‡½æ•°æ¥å£è¯¦è§£

### ğŸ”§ æœ¬åœ°åŸŸåè¡¨ç®¡ç†å‡½æ•°

#### `int domain_table_init(domain_table_t* table)`
**åŠŸèƒ½**: åˆå§‹åŒ–æœ¬åœ°åŸŸåè¡¨
**å‚æ•°**: 
- `table`: åŸŸåè¡¨ç»“æ„æŒ‡é’ˆ
**è¿”å›å€¼**: 
- `MYSUCCESS`: åˆå§‹åŒ–æˆåŠŸ
- `MYERROR`: å‚æ•°é”™è¯¯
**å®ç°é€»è¾‘**:
1. æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§
2. æ¸…é›¶æ‰€æœ‰å“ˆå¸Œæ§½ä½
3. åˆå§‹åŒ–è®¡æ•°å™¨å’Œæ—¶é—´æˆ³
4. è®°å½•åˆå§‹åŒ–æ—¥å¿—

#### `int domain_table_load_from_file(domain_table_t* table, const char* filename)`
**åŠŸèƒ½**: ä»æ–‡ä»¶åŠ è½½åŸŸå-IPæ˜ å°„è¡¨
**å‚æ•°**:
- `table`: åŸŸåè¡¨ç»“æ„æŒ‡é’ˆ
- `filename`: é…ç½®æ–‡ä»¶è·¯å¾„(é€šå¸¸ä¸º"dnsrelay.txt")
**è¿”å›å€¼**:
- `MYSUCCESS`: åŠ è½½æˆåŠŸ
- `MYERROR`: æ–‡ä»¶æ‰“å¼€å¤±è´¥æˆ–å‚æ•°é”™è¯¯
**å®ç°é€»è¾‘**:
1. æ‰“å¼€é…ç½®æ–‡ä»¶
2. é€è¡Œè§£æ"IP åŸŸå"æ ¼å¼
3. è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ(#å¼€å¤´)
4. ä¸ºæ¯ä¸ªæ¡ç›®åˆ†é…å†…å­˜å¹¶å¡«å……æ•°æ®
5. æ£€æµ‹0.0.0.0æ ‡è®°è®¾ç½®é˜»æ­¢æ ‡å¿—
6. ä½¿ç”¨å“ˆå¸Œå‡½æ•°æ’å…¥å“ˆå¸Œè¡¨
7. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’ŒåŠ è½½æ—¶é—´

#### `domain_entry_t* domain_table_lookup(domain_table_t* table, const char* domain)`
**åŠŸèƒ½**: æŸ¥æ‰¾åŸŸåè¡¨æ¡ç›®
**å‚æ•°**:
- `table`: åŸŸåè¡¨ç»“æ„æŒ‡é’ˆ
- `domain`: è¦æŸ¥æ‰¾çš„åŸŸå
**è¿”å›å€¼**:
- `éNULL`: æ‰¾åˆ°çš„åŸŸåæ¡ç›®æŒ‡é’ˆ
- `NULL`: æœªæ‰¾åˆ°æˆ–å‚æ•°é”™è¯¯
**å®ç°é€»è¾‘**:
1. è®¡ç®—åŸŸåå“ˆå¸Œå€¼
2. å®šä½åˆ°å¯¹åº”å“ˆå¸Œæ§½
3. éå†å†²çªé“¾è¡¨
4. ä½¿ç”¨ä¸åŒºåˆ†å¤§å°å†™æ¯”è¾ƒ(`strcasecmp`)
5. è¿”å›åŒ¹é…çš„æ¡ç›®

#### `void domain_table_destroy(domain_table_t* table)`
**åŠŸèƒ½**: é”€æ¯åŸŸåè¡¨å¹¶é‡Šæ”¾æ‰€æœ‰å†…å­˜
**å‚æ•°**:
- `table`: åŸŸåè¡¨ç»“æ„æŒ‡é’ˆ
**å®ç°é€»è¾‘**:
1. éå†æ‰€æœ‰å“ˆå¸Œæ§½
2. é‡Šæ”¾æ¯ä¸ªå†²çªé“¾è¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹
3. æ¸…é›¶å“ˆå¸Œè¡¨æŒ‡é’ˆ
4. é‡ç½®è®¡æ•°å™¨

### ğŸš€ LRUç¼“å­˜æ ¸å¿ƒå‡½æ•°

#### `int dns_cache_init(dns_lru_cache_t* cache, int max_size)`
**åŠŸèƒ½**: åˆå§‹åŒ–LRUç¼“å­˜
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
- `max_size`: æœ€å¤§ç¼“å­˜å®¹é‡
**è¿”å›å€¼**:
- `MYSUCCESS`: åˆå§‹åŒ–æˆåŠŸ
- `MYERROR`: å†…å­˜åˆ†é…å¤±è´¥æˆ–å‚æ•°é”™è¯¯
**å®ç°é€»è¾‘**:
1. éªŒè¯å‚æ•°æœ‰æ•ˆæ€§
2. æ¸…é›¶å“ˆå¸Œè¡¨
3. é¢„åˆ†é…æ¡ç›®æ± å†…å­˜(`calloc`)
4. åˆå§‹åŒ–LRUé“¾è¡¨æŒ‡é’ˆ
5. æ¸…é›¶ç»Ÿè®¡è®¡æ•°å™¨
6. è®°å½•åˆå§‹åŒ–æ—¥å¿—

#### `dns_cache_entry_t* dns_cache_get(dns_lru_cache_t* cache, const char* domain)`
**åŠŸèƒ½**: ä»ç¼“å­˜è·å–DNSæ¡ç›®(æ ¸å¿ƒæŸ¥æ‰¾å‡½æ•°)
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
- `domain`: è¦æŸ¥æ‰¾çš„åŸŸå
**è¿”å›å€¼**:
- `éNULL`: æ‰¾åˆ°çš„ç¼“å­˜æ¡ç›®æŒ‡é’ˆ
- `NULL`: æœªæ‰¾åˆ°ã€å·²è¿‡æœŸæˆ–å‚æ•°é”™è¯¯
**å®ç°é€»è¾‘**:
1. è®¡ç®—åŸŸåå“ˆå¸Œå€¼å®šä½æ§½ä½
2. éå†å“ˆå¸Œå†²çªé“¾è¡¨
3. ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…åŸŸå
4. æ£€æŸ¥TTLæ˜¯å¦è¿‡æœŸ
5. å¦‚æœæœ‰æ•ˆï¼Œæ›´æ–°è®¿é—®æ—¶é—´
6. è°ƒç”¨`lru_move_to_head()`ç§»åˆ°é“¾è¡¨å¤´éƒ¨
7. å¢åŠ å‘½ä¸­è®¡æ•°å™¨
8. è¿”å›æ¡ç›®æŒ‡é’ˆ

#### `int dns_cache_put(dns_lru_cache_t* cache, const char* domain, DNS_ENTITY* response, int ttl)`
**åŠŸèƒ½**: å‘ç¼“å­˜æ·»åŠ æˆ–æ›´æ–°DNSæ¡ç›®
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
- `domain`: åŸŸå
- `response`: DNSå“åº”ç»“æ„
- `ttl`: ç”Ÿå­˜æ—¶é—´(ç§’)
**è¿”å›å€¼**:
- `MYSUCCESS`: æ·»åŠ /æ›´æ–°æˆåŠŸ
- `MYERROR`: æ“ä½œå¤±è´¥
**å®ç°é€»è¾‘**:
1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨(è°ƒç”¨`dns_cache_get`)
2. å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°ç°æœ‰æ¡ç›®çš„å“åº”å’Œè¿‡æœŸæ—¶é—´
3. å¦‚æœä¸å­˜åœ¨ä¸”ç¼“å­˜å·²æ»¡ï¼Œè°ƒç”¨`lru_remove_tail()`æ·˜æ±°æœ€æ—§æ¡ç›®
4. ä»æ¡ç›®æ± ä¸­æ‰¾åˆ°ç©ºé—²æ¡ç›®
5. å¡«å……æ¡ç›®æ•°æ®(åŸŸåã€å“åº”ã€æ—¶é—´æˆ³)
6. æ’å…¥å“ˆå¸Œè¡¨
7. è°ƒç”¨`lru_move_to_head()`æ’å…¥LRUé“¾è¡¨å¤´éƒ¨
8. å¢åŠ å½“å‰å¤§å°è®¡æ•°

#### `void lru_move_to_head(dns_lru_cache_t* cache, dns_cache_entry_t* entry)`
**åŠŸèƒ½**: å°†ç¼“å­˜æ¡ç›®ç§»åŠ¨åˆ°LRUé“¾è¡¨å¤´éƒ¨(æœ€è¿‘ä½¿ç”¨)
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
- `entry`: è¦ç§»åŠ¨çš„æ¡ç›®
**å®ç°é€»è¾‘**:
1. æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¤´éƒ¨èŠ‚ç‚¹
2. ä»å½“å‰ä½ç½®æ–­å¼€é“¾æ¥(æ›´æ–°å‰é©±å’Œåç»§çš„æŒ‡é’ˆ)
3. å¦‚æœæ˜¯å°¾éƒ¨èŠ‚ç‚¹ï¼Œæ›´æ–°å°¾éƒ¨æŒ‡é’ˆ
4. æ’å…¥åˆ°å¤´éƒ¨(æ›´æ–°å¤´éƒ¨æŒ‡é’ˆå’Œç›¸å…³é“¾æ¥)
5. å¦‚æœé“¾è¡¨ä¸ºç©ºï¼ŒåŒæ—¶è®¾ç½®å°¾éƒ¨æŒ‡é’ˆ

#### `void lru_remove_tail(dns_lru_cache_t* cache)`
**åŠŸèƒ½**: ç§»é™¤LRUé“¾è¡¨å°¾éƒ¨æ¡ç›®(æœ€ä¹…æœªä½¿ç”¨)
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
**å®ç°é€»è¾‘**:
1. è·å–å°¾éƒ¨æ¡ç›®æŒ‡é’ˆ
2. ä»å“ˆå¸Œè¡¨ä¸­ç§»é™¤(éå†å¯¹åº”æ§½ä½çš„å†²çªé“¾è¡¨)
3. ä»LRUé“¾è¡¨ä¸­æ–­å¼€(æ›´æ–°å‰é©±èŠ‚ç‚¹æŒ‡é’ˆ)
4. é‡Šæ”¾DNSå“åº”å†…å­˜(`free_dns_entity`)
5. æ¸…é›¶æ¡ç›®æ•°æ®(`memset`)
6. æ›´æ–°ç¼“å­˜å¤§å°å’Œæ·˜æ±°è®¡æ•°å™¨

#### `void dns_cache_cleanup_expired(dns_lru_cache_t* cache)`
**åŠŸèƒ½**: æ¸…ç†è¿‡æœŸçš„ç¼“å­˜æ¡ç›®
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
**å®ç°é€»è¾‘**:
1. è·å–å½“å‰æ—¶é—´æˆ³
2. ä»å°¾éƒ¨å¼€å§‹éå†LRUé“¾è¡¨
3. æ£€æŸ¥æ¯ä¸ªæ¡ç›®çš„è¿‡æœŸæ—¶é—´
4. è°ƒç”¨`lru_remove_tail()`ç§»é™¤è¿‡æœŸæ¡ç›®
5. ç»Ÿè®¡æ¸…ç†æ•°é‡å¹¶è®°å½•æ—¥å¿—

#### `void dns_cache_print_stats(dns_lru_cache_t* cache)`
**åŠŸèƒ½**: æ‰“å°ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
**è¾“å‡ºä¿¡æ¯**:
- å½“å‰å¤§å°å’Œæœ€å¤§å®¹é‡
- ç¼“å­˜å‘½ä¸­æ¬¡æ•°å’Œæœªå‘½ä¸­æ¬¡æ•°
- ç¼“å­˜æ·˜æ±°æ¬¡æ•°
- å‘½ä¸­ç‡ç™¾åˆ†æ¯”

#### `void dns_cache_destroy(dns_lru_cache_t* cache)`
**åŠŸèƒ½**: é”€æ¯ç¼“å­˜å¹¶é‡Šæ”¾æ‰€æœ‰èµ„æº
**å‚æ•°**:
- `cache`: ç¼“å­˜ç»“æ„æŒ‡é’ˆ
**å®ç°é€»è¾‘**:
1. éå†æ¡ç›®æ± é‡Šæ”¾æ‰€æœ‰DNSå“åº”
2. é‡Šæ”¾æ¡ç›®æ± å†…å­˜
3. æ¸…é›¶å“ˆå¸Œè¡¨æŒ‡é’ˆ
4. é‡ç½®é“¾è¡¨æŒ‡é’ˆå’Œè®¡æ•°å™¨

### ğŸŒ ç»Ÿä¸€æŸ¥è¯¢æ¥å£å‡½æ•°

#### `dns_query_response_t* dns_relay_query(const char* domain, unsigned short qtype)`
**åŠŸèƒ½**: ç»Ÿä¸€DNSæŸ¥è¯¢æ¥å£ï¼Œå®ç°ä¸‰çº§æŸ¥è¯¢æ¶æ„
**å‚æ•°**:
- `domain`: è¦æŸ¥è¯¢çš„åŸŸå
- `qtype`: DNSæŸ¥è¯¢ç±»å‹(Aã€AAAAç­‰)
**è¿”å›å€¼**:
- `éNULL`: æŸ¥è¯¢å“åº”ç»“æ„æŒ‡é’ˆ
- `NULL`: å†…å­˜åˆ†é…å¤±è´¥
**å®ç°é€»è¾‘**:
1. åˆ†é…å“åº”ç»“æ„å†…å­˜
2. **ç¬¬ä¸€çº§**: è°ƒç”¨`domain_table_lookup()`æŸ¥è¯¢æœ¬åœ°è¡¨
   - å¦‚æœæ‰¾åˆ°ä¸”è¢«é˜»æ­¢ï¼Œè¿”å›`QUERY_RESULT_BLOCKED`
   - å¦‚æœæ‰¾åˆ°ä¸”æœ‰æ•ˆï¼Œè¿”å›`QUERY_RESULT_LOCAL_HIT`å’ŒIPåœ°å€
3. **ç¬¬äºŒçº§**: è°ƒç”¨`dns_cache_get()`æŸ¥è¯¢ç¼“å­˜
   - å¦‚æœå‘½ä¸­ï¼Œè¿”å›`QUERY_RESULT_CACHE_HIT`å’ŒDNSå“åº”
4. **ç¬¬ä¸‰çº§**: è¿”å›`QUERY_RESULT_CACHE_MISS`ï¼Œéœ€è¦æŸ¥è¯¢ä¸Šæ¸¸DNS

#### `int dns_relay_init(const char* domain_file)`
**åŠŸèƒ½**: åˆå§‹åŒ–æ•´ä¸ªDNSä¸­ç»§æœåŠ¡
**å‚æ•°**:
- `domain_file`: åŸŸåè¡¨æ–‡ä»¶è·¯å¾„
**è¿”å›å€¼**:
- `MYSUCCESS`: åˆå§‹åŒ–æˆåŠŸ
- `MYERROR`: åˆå§‹åŒ–å¤±è´¥
**å®ç°é€»è¾‘**:
1. è°ƒç”¨`domain_table_init()`åˆå§‹åŒ–åŸŸåè¡¨
2. è°ƒç”¨`domain_table_load_from_file()`åŠ è½½é…ç½®æ–‡ä»¶
3. è°ƒç”¨`dns_cache_init()`åˆå§‹åŒ–LRUç¼“å­˜
4. å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œæ¸…ç†å·²åˆ†é…èµ„æº

#### `void dns_relay_cleanup(void)`
**åŠŸèƒ½**: æ¸…ç†DNSä¸­ç»§æœåŠ¡å¹¶æ‰“å°ç»Ÿè®¡ä¿¡æ¯
**å®ç°é€»è¾‘**:
1. è°ƒç”¨`dns_cache_print_stats()`æ‰“å°ç¼“å­˜ç»Ÿè®¡
2. è°ƒç”¨`dns_cache_destroy()`é”€æ¯ç¼“å­˜
3. è°ƒç”¨`domain_table_destroy()`é”€æ¯åŸŸåè¡¨
4. è®°å½•æ¸…ç†å®Œæˆæ—¥å¿—

### ğŸ”— é›†æˆè¾…åŠ©å‡½æ•°

#### `int dns_relay_cache_response(const char* domain, DNS_ENTITY* response)`
**åŠŸèƒ½**: å°†ä¸Šæ¸¸DNSå“åº”æ·»åŠ åˆ°ç¼“å­˜
**å‚æ•°**:
- `domain`: åŸŸå
- `response`: DNSå“åº”ç»“æ„
**è¿”å›å€¼**:
- `MYSUCCESS`: ç¼“å­˜æˆåŠŸ
- `MYERROR`: ç¼“å­˜å¤±è´¥
**ä½¿ç”¨åœºæ™¯**: åœ¨æ”¶åˆ°ä¸Šæ¸¸DNSæœåŠ¡å™¨å“åº”åè°ƒç”¨

#### `void dns_relay_get_stats(int* domain_count, int* cache_size, unsigned long* cache_hits, unsigned long* cache_misses)`
**åŠŸèƒ½**: è·å–ç»Ÿè®¡ä¿¡æ¯
**å‚æ•°**: å„ç»Ÿè®¡æ•°æ®çš„è¾“å‡ºæŒ‡é’ˆ
**ç”¨é€”**: ç›‘æ§å’Œè°ƒè¯•

#### `unsigned int hash_domain(const char* domain)`
**åŠŸèƒ½**: åŸŸåå“ˆå¸Œå‡½æ•°
**ç®—æ³•**: djb2å“ˆå¸Œç®—æ³•
**ç‰¹æ€§**: 
- è‡ªåŠ¨è½¬æ¢ä¸ºå°å†™
- è‰¯å¥½çš„åˆ†å¸ƒç‰¹æ€§
- å¿«é€Ÿè®¡ç®—

---

## é›†æˆæŒ‡å—

### 1. ç¼–è¯‘é…ç½®

åœ¨`CMakeLists.txt`ä¸­ç¡®ä¿åŒ…å«äº†ç¼“å­˜æ¨¡å—ï¼š
```cmake
# å·²ç»åŒ…å«åœ¨ç°æœ‰é…ç½®ä¸­
include_directories(include)
```

### 2. å¤´æ–‡ä»¶å¼•å…¥

åœ¨éœ€è¦ä½¿ç”¨ç¼“å­˜åŠŸèƒ½çš„æºæ–‡ä»¶ä¸­ï¼š
```c
#include "DNScache/relayBuild.h"
```

### 3. ä¸»ç¨‹åºé›†æˆ

#### åœ¨`main()`å‡½æ•°ä¸­åˆå§‹åŒ–ï¼š
```c
int main(int argc, char* argv[]) {
    // è§£æå‘½ä»¤è¡Œå‚æ•°è·å–é…ç½®æ–‡ä»¶è·¯å¾„
    const char* config_file = "dnsrelay.txt";  // é»˜è®¤é…ç½®æ–‡ä»¶
    
    // åˆå§‹åŒ–DNSä¸­ç»§æœåŠ¡
    if (dns_relay_init(config_file) != MYSUCCESS) {
        log_error("DNSä¸­ç»§æœåŠ¡åˆå§‹åŒ–å¤±è´¥");
        return -1;
    }
    
    // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
    
    // ä¸»æœåŠ¡å¾ªç¯
    while (running) {
        // å¤„ç†DNSè¯·æ±‚
    }
    
    // ç¨‹åºé€€å‡ºå‰æ¸…ç†
    dns_relay_cleanup();
    return 0;
}
```

### 4. DNSè¯·æ±‚å¤„ç†é›†æˆ

#### æ›¿æ¢ç°æœ‰çš„åŸŸåæŸ¥è¯¢é€»è¾‘ï¼š
```c
void handle_dns_query(const char* domain, unsigned short qtype, 
                     struct sockaddr_in* client_addr) {
    // ä½¿ç”¨ç»Ÿä¸€æŸ¥è¯¢æ¥å£
    dns_query_response_t* result = dns_relay_query(domain, qtype);
    if (!result) {
        log_error("æŸ¥è¯¢å¤±è´¥: %s", domain);
        return;
    }
    
    switch (result->result_type) {
        case QUERY_RESULT_BLOCKED:
            // æ„å»ºåŸŸåä¸å­˜åœ¨çš„DNSå“åº”
            send_nxdomain_response(client_addr, domain);
            log_info("é˜»æ­¢åŸŸåè®¿é—®: %s", domain);
            break;
            
        case QUERY_RESULT_LOCAL_HIT:
            // ä½¿ç”¨æœ¬åœ°IPåœ°å€æ„å»ºDNSå“åº”
            send_dns_response(client_addr, domain, result->resolved_ip);
            log_info("æœ¬åœ°è¡¨å‘½ä¸­: %s -> %s", domain, result->resolved_ip);
            break;
            
        case QUERY_RESULT_CACHE_HIT:
            // ç›´æ¥å‘é€ç¼“å­˜çš„DNSå“åº”
            send_cached_dns_response(client_addr, result->dns_response);
            log_info("ç¼“å­˜å‘½ä¸­: %s", domain);
            break;
            
        case QUERY_RESULT_CACHE_MISS:
            // æŸ¥è¯¢ä¸Šæ¸¸DNSæœåŠ¡å™¨
            query_upstream_dns(domain, qtype, client_addr);
            log_debug("ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢ä¸Šæ¸¸: %s", domain);
            break;
            
        case QUERY_RESULT_ERROR:
            log_error("æŸ¥è¯¢é”™è¯¯: %s", domain);
            break;
    }
    
    // é‡Šæ”¾æŸ¥è¯¢ç»“æœ
    free(result);
}
```

### 5. ä¸Šæ¸¸DNSå“åº”å¤„ç†

#### åœ¨æ”¶åˆ°ä¸Šæ¸¸DNSå“åº”åç¼“å­˜ç»“æœï¼š
```c
void handle_upstream_response(const char* domain, DNS_ENTITY* response,
                            struct sockaddr_in* client_addr) {
    // å°†å“åº”æ·»åŠ åˆ°ç¼“å­˜
    if (dns_relay_cache_response(domain, response) == MYSUCCESS) {
        log_debug("æˆåŠŸç¼“å­˜ä¸Šæ¸¸å“åº”: %s", domain);
    }
    
    // è½¬å‘å“åº”ç»™å®¢æˆ·ç«¯
    forward_dns_response(client_addr, response);
}
```

---

## æ€§èƒ½ç‰¹æ€§

### ğŸš€ æ—¶é—´å¤æ‚åº¦
- **æŸ¥æ‰¾æ“ä½œ**: O(1) å¹³å‡æƒ…å†µï¼ŒO(n) æœ€åæƒ…å†µ(å“ˆå¸Œå†²çª)
- **æ’å…¥æ“ä½œ**: O(1) å¹³å‡æƒ…å†µ
- **åˆ é™¤æ“ä½œ**: O(1)
- **LRUæ›´æ–°**: O(1)

### ğŸ’¾ ç©ºé—´å¤æ‚åº¦
- **å“ˆå¸Œè¡¨**: O(n) å…¶ä¸­nä¸ºç¼“å­˜æ¡ç›®æ•°
- **LRUé“¾è¡¨**: O(n) é¢å¤–ç©ºé—´
- **æ€»ç©ºé—´**: O(n) çº¿æ€§ç©ºé—´å¤æ‚åº¦

### ğŸ“Š æ€§èƒ½å‚æ•°
```c
#define DNS_CACHE_SIZE 1000             // ç¼“å­˜å®¹é‡: 1000æ¡è®°å½•
#define DNS_CACHE_HASH_SIZE 2048        // å“ˆå¸Œè¡¨å¤§å°: 2048ä¸ªæ§½ä½
#define DOMAIN_TABLE_HASH_SIZE 4096     // åŸŸåè¡¨å“ˆå¸Œå¤§å°: 4096ä¸ªæ§½ä½
#define DEFAULT_TTL 300                 // é»˜è®¤TTL: 5åˆ†é’Ÿ
```

### ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§
1. **é¢„åˆ†é…å†…å­˜æ± **: é¿å…é¢‘ç¹malloc/free
2. **åŒé‡å“ˆå¸Œ**: åŸŸåè¡¨å’Œç¼“å­˜åˆ†åˆ«ä¼˜åŒ–
3. **TTLè‡ªåŠ¨æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸæ¡ç›®
4. **ç»Ÿè®¡ç›‘æ§**: å®æ—¶æ€§èƒ½æŒ‡æ ‡

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ä½¿ç”¨æµç¨‹
```c
#include "DNScache/relayBuild.h"

int main() {
    // 1. åˆå§‹åŒ–
    if (dns_relay_init("dnsrelay.txt") != MYSUCCESS) {
        return -1;
    }
    
    // 2. æŸ¥è¯¢åŸŸå
    dns_query_response_t* result = dns_relay_query("www.baidu.com", A);
    if (result) {
        switch (result->result_type) {
            case QUERY_RESULT_LOCAL_HIT:
                printf("æœ¬åœ°è§£æ: %s\n", result->resolved_ip);
                break;
            case QUERY_RESULT_CACHE_HIT:
                printf("ç¼“å­˜å‘½ä¸­\n");
                break;
            case QUERY_RESULT_CACHE_MISS:
                printf("éœ€è¦æŸ¥è¯¢ä¸Šæ¸¸DNS\n");
                break;
        }
        free(result);
    }
    
    // 3. æ¸…ç†
    dns_relay_cleanup();
    return 0;
}
```

### 2. ç»Ÿè®¡ä¿¡æ¯æŸ¥çœ‹
```c
void print_cache_statistics() {
    int domain_count, cache_size;
    unsigned long cache_hits, cache_misses;
    
    dns_relay_get_stats(&domain_count, &cache_size, &cache_hits, &cache_misses);
    
    printf("åŸŸåè¡¨æ¡ç›®: %d\n", domain_count);
    printf("ç¼“å­˜å¤§å°: %d\n", cache_size);
    printf("ç¼“å­˜å‘½ä¸­: %lu\n", cache_hits);
    printf("ç¼“å­˜æœªå‘½ä¸­: %lu\n", cache_misses);
    
    if (cache_hits + cache_misses > 0) {
        double hit_rate = (double)cache_hits / (cache_hits + cache_misses) * 100.0;
        printf("å‘½ä¸­ç‡: %.2f%%\n", hit_rate);
    }
}
```

---

## é…ç½®è¯´æ˜

### 1. dnsrelay.txtæ ¼å¼
```
# æ³¨é‡Šè¡Œä»¥#å¼€å¤´
# æ ¼å¼: IPåœ°å€ åŸŸå
# 0.0.0.0è¡¨ç¤ºé˜»æ­¢è¯¥åŸŸå

# é˜»æ­¢æ¶æ„ç½‘ç«™
0.0.0.0 malware.example.com
0.0.0.0 phishing.example.com

# æœ¬åœ°è§£æ
192.168.1.100 local.server.com
10.0.0.1 internal.company.com

# å…¬å…±åŸŸåæ˜ å°„
202.108.33.89 sina.com.cn
61.135.181.175 sohu.com
```

### 2. ç¼–è¯‘æ—¶é…ç½®
```c
// åœ¨relayBuild.hä¸­å¯è°ƒæ•´çš„å‚æ•°
#define MAX_DOMAIN_LENGTH 256           // æœ€å¤§åŸŸåé•¿åº¦
#define MAX_IP_LENGTH 16                // æœ€å¤§IPé•¿åº¦
#define DNS_CACHE_SIZE 1000             // ç¼“å­˜å®¹é‡
#define DNS_CACHE_HASH_SIZE 2048        // ç¼“å­˜å“ˆå¸Œè¡¨å¤§å°
#define DOMAIN_TABLE_HASH_SIZE 4096     // åŸŸåè¡¨å“ˆå¸Œå¤§å°
#define DEFAULT_TTL 300                 // é»˜è®¤TTL(ç§’)
```

### 3. è¿è¡Œæ—¶é…ç½®
é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶ï¼š
```bash
./dnsrelay -d 8.8.8.8 custom_domains.txt
```

---

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•å»ºè®®

### 1. åŸºå‡†æµ‹è¯•
```c
void benchmark_cache_performance() {
    clock_t start, end;
    const int test_count = 10000;
    
    // æµ‹è¯•æŸ¥æ‰¾æ€§èƒ½
    start = clock();
    for (int i = 0; i < test_count; i++) {
        dns_query_response_t* result = dns_relay_query("test.domain.com", A);
        if (result) free(result);
    }
    end = clock();
    
    double cpu_time = ((double)(end - start)) / CLOCKS_PER_SEC;
    printf("æŸ¥æ‰¾æ€§èƒ½: %dæ¬¡æŸ¥è¯¢è€—æ—¶%.2fç§’\n", test_count, cpu_time);
    printf("å¹³å‡æ¯æ¬¡æŸ¥è¯¢: %.2få¾®ç§’\n", cpu_time * 1000000 / test_count);
}
```

### 2. å†…å­˜ä½¿ç”¨ç›‘æ§
```c
void monitor_memory_usage() {
    // è·å–ç»Ÿè®¡ä¿¡æ¯
    dns_cache_print_stats(&g_dns_cache);
    
    // è®¡ç®—å†…å­˜ä½¿ç”¨
    size_t cache_memory = sizeof(dns_lru_cache_t) + 
                         g_dns_cache.max_size * sizeof(dns_cache_entry_t);
    printf("ç¼“å­˜å†…å­˜ä½¿ç”¨: %zu KB\n", cache_memory / 1024);
}
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **ç¼“å­˜å‘½ä¸­ç‡ä½**
   - å¢åŠ ç¼“å­˜å®¹é‡ (`DNS_CACHE_SIZE`)
   - æ£€æŸ¥TTLè®¾ç½®æ˜¯å¦è¿‡çŸ­
   - åˆ†ææŸ¥è¯¢æ¨¡å¼æ˜¯å¦é€‚åˆç¼“å­˜

2. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - å‡å°‘ç¼“å­˜å®¹é‡
   - å¯ç”¨å®šæœŸè¿‡æœŸæ¸…ç†
   - æ£€æŸ¥DNSå“åº”æ˜¯å¦æ­£ç¡®é‡Šæ”¾

3. **å“ˆå¸Œå†²çªè¿‡å¤š**
   - å¢åŠ å“ˆå¸Œè¡¨å¤§å°
   - æ£€æŸ¥åŸŸååˆ†å¸ƒæ˜¯å¦å‡åŒ€
   - è€ƒè™‘ä½¿ç”¨æ›´å¥½çš„å“ˆå¸Œå‡½æ•°

4. **é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™
   - éªŒè¯æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯

---

## ğŸ“ æ€»ç»“

æœ¬LRUç¼“å­˜æ¨¡å—å®Œå…¨æ»¡è¶³è¯¾ç¨‹è®¾è®¡è¦æ±‚ï¼Œæä¾›äº†ï¼š

âœ… **å®Œæ•´çš„LRUæœºåˆ¶**: åŸºäºè®¿é—®æ—¶é—´çš„è‡ªåŠ¨æ·˜æ±°ç­–ç•¥  
âœ… **é«˜æ€§èƒ½å®ç°**: O(1)æŸ¥æ‰¾å’Œæ›´æ–°å¤æ‚åº¦  
âœ… **ä¸‰çº§æŸ¥è¯¢æ¶æ„**: æœ¬åœ°è¡¨â†’ç¼“å­˜â†’ä¸Šæ¸¸DNSçš„å®Œæ•´è§£å†³æ–¹æ¡ˆ  
âœ… **TTLæ”¯æŒ**: åŸºäºDNSåè®®çš„è‡ªåŠ¨è¿‡æœŸæœºåˆ¶  
âœ… **ç»Ÿè®¡ç›‘æ§**: å®Œæ•´çš„æ€§èƒ½æŒ‡æ ‡å’Œè°ƒè¯•ä¿¡æ¯  
âœ… **æ˜“äºé›†æˆ**: æ¸…æ™°çš„APIæ¥å£å’Œè¯¦ç»†çš„é›†æˆæŒ‡å—  

è¯¥å®ç°ä¸ä»…æ»¡è¶³äº†åŸºæœ¬çš„ç¼“å­˜éœ€æ±‚ï¼Œè¿˜æä¾›äº†ç”Ÿäº§çº§åˆ«çš„æ€§èƒ½å’Œå¯é æ€§ï¼Œä¸ºDNSä¸­ç»§æœåŠ¡å™¨æä¾›äº†å¼ºå¤§çš„ç¼“å­˜æ”¯æŒã€‚ 